<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Tracking</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .chart-container {
            margin-top: 2rem;
            width: 100%;
            height: 400px;
        }

        h1,
        h2 {
            color: #333;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        select {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        label {
            font-weight: bold;
        }

        #samples-container {
            overflow-x: auto;
        }

        .instruction-box {
            padding: 1.5rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-align: center;
            font-size: 1.1rem;
            color: #495057;
        }

        button {
            padding: 0.5rem 1rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background-color: #0069d9;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Sample Tracking Dashboard</h1>

    <div class="filters">
        <div class="filter-group">
            <label for="sponsor-select">Faculty Sponsor</label>
            <select id="sponsor-select" hx-get="/api/studies" hx-target="#study-select" hx-trigger="change"
                hx-include="[name='sponsor']" name="sponsor" required>
                <option value="">Select a sponsor...</option>
                <!-- Will be populated via JavaScript -->
            </select>
        </div>

        <div class="filter-group">
            <label for="study-select">Study</label>
            <select id="study-select" name="study" disabled required>
                <option value="">Select a study...</option>
                <!-- Will be populated when a sponsor is selected -->
            </select>
        </div>
    </div>

    <button id="apply-filters" hx-get="/api/samples" hx-target="#samples-container"
        hx-include="[name='sponsor'],[name='study']" hx-trigger="click" disabled>
        Apply Filters
    </button>

    <h2>Sample Data</h2>
    <div id="samples-container">
        <div class="instruction-box">
            Please select a Faculty Sponsor and Study to view sample data.
        </div>
    </div>

    <h2>Processing Time Chart</h2>
    <div class="chart-container" id="chart-container">
        <div class="instruction-box">
            Please select a Faculty Sponsor and Study to view the chart.
        </div>
        <canvas id="timingChart" class="hidden"></canvas>
    </div>

    <script>
        // Debug function to check what's being returned from the API
        function logResponse(response) {
            console.log("Response:", response);
            return response;
        }

        // Load faculty sponsors on page load with better debug logging
        fetch('/api/filters')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Raw sponsors data:", data);
                const sponsorSelect = document.getElementById('sponsor-select');

                // Ensure we have an array of sponsors
                if (!data.facultySponsors || !Array.isArray(data.facultySponsors)) {
                    console.error("Invalid sponsors data format:", data);
                    return;
                }

                console.log(`Found ${data.facultySponsors.length} sponsors`);

                // Clear any existing options (except the default)
                sponsorSelect.innerHTML = '<option value="">Select a sponsor...</option>';

                // Add sponsors to dropdown
                data.facultySponsors.forEach(sponsor => {
                    console.log(`Adding sponsor: ${sponsor}`);
                    const option = document.createElement('option');
                    option.value = sponsor;
                    option.textContent = sponsor;
                    sponsorSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching sponsors:", error);
                alert("Failed to load faculty sponsors. Please refresh the page.");
            });

        // Handle study select enabling/disabling
        document.getElementById('sponsor-select').addEventListener('change', function () {
            const studySelect = document.getElementById('study-select');
            const applyButton = document.getElementById('apply-filters');

            if (this.value) {
                studySelect.disabled = false;
                // Don't enable the apply button yet - we need both values
            } else {
                studySelect.disabled = true;
                studySelect.innerHTML = '<option value="">Select a study...</option>';
                applyButton.disabled = true;
            }
        });

        // Process studies response with better handling
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (event.detail.target.id === 'study-select') {
                try {
                    const rawData = event.detail.xhr.responseText;
                    console.log("Raw studies response:", rawData);

                    const data = JSON.parse(rawData);
                    console.log("Parsed studies data:", data);
                    const studySelect = document.getElementById('study-select');

                    // Clear existing options
                    studySelect.innerHTML = '<option value="">Select a study...</option>';

                    // Ensure we have an array of studies
                    if (!data.studies || !Array.isArray(data.studies)) {
                        console.error("Invalid studies data format:", data);
                        return;
                    }

                    console.log(`Found ${data.studies.length} studies`);

                    // Add studies to dropdown
                    data.studies.forEach(study => {
                        console.log(`Adding study: ${study}`);
                        const option = document.createElement('option');
                        option.value = study;
                        option.textContent = study;
                        studySelect.appendChild(option);
                    });
                } catch (e) {
                    console.error("Error parsing studies response:", e);
                }
            }

            // Enable apply button when samples are loaded
            if (event.detail.target.id === 'samples-container') {
                // Show the chart container and update chart
                const sponsor = document.getElementById('sponsor-select').value;
                const study = document.getElementById('study-select').value;

                if (sponsor && study) {
                    updateChartWithFilters(sponsor, study);
                }
            }
        });

        // Enable apply button when both selections are made
        document.getElementById('study-select').addEventListener('change', function () {
            const sponsorSelect = document.getElementById('sponsor-select');
            const applyButton = document.getElementById('apply-filters');

            if (this.value && sponsorSelect.value) {
                applyButton.disabled = false;
            } else {
                applyButton.disabled = true;
            }
        });

        // Update chart with filter values
        function updateChartWithFilters(sponsor, study) {
            const params = new URLSearchParams();
            params.append('sponsor', sponsor);
            params.append('study', study);

            fetch('/api/chart?' + params.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Show the chart and hide the instruction box
                    document.querySelector('#chart-container .instruction-box').classList.add('hidden');
                    document.getElementById('timingChart').classList.remove('hidden');

                    updateChart(data);
                })
                .catch(error => {
                    console.error("Error fetching chart data:", error);
                    alert("Failed to load chart data. Please try again.");
                });
        }

        // Apply button handler - also updates the chart
        document.getElementById('apply-filters').addEventListener('click', function () {
            const sponsor = document.getElementById('sponsor-select').value;
            const study = document.getElementById('study-select').value;

            if (sponsor && study) {
                // HTMX will handle the sample table update
                // We manually trigger chart update here
                updateChartWithFilters(sponsor, study);
            }
        });

        let chart;

        function updateChart(data) {
            if (chart) {
                chart.destroy();
            }

            createChart(data);
        }

        function createChart(data) {
            // Check if we have data to display
            if (!data.labels || data.labels.length === 0) {
                console.log("No chart data available");
                return;
            }

            const ctx = document.getElementById('timingChart').getContext('2d');

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Library Time',
                            data: data.libraryTime,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Sequencing Time',
                            data: data.sequencingTime,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Samples'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Library and Sequencing Processing Times'
                        },
                        tooltip: {
                            callbacks: {
                                footer: function (tooltipItems) {
                                    const item = tooltipItems[0];
                                    const datasetIndex = item.datasetIndex;
                                    const index = item.dataIndex;

                                    if (datasetIndex === 0) {
                                        return 'Sample ID: ' + data.sampleIds[index];
                                    }
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>